#!/bin/sh
# End of Day chores to run

################################################################################
# Load my Git functions
. ~/.zsh/git

# repositories to push
git_repositories="
    ~/Develop/pmade/rc
    ~/Documents/pmade/pmade-inc
    ~/Documents/pmade/pmade.com"

################################################################################
# Check each repo to ensure there are no uncomitted changes.
eod_git_check_uncommitted ()
{
  if git_repo_has_changes; then
    die "uncommitted changes in $1"
  fi
}

################################################################################
# Push all Git repositories back to pmade.com
eod_git_push_all_repositories ()
{
  git pull > /dev/null 2>&1 || die "failed pull: $1"
  git push > /dev/null 2>&1 || die "failed push: $1"
}

################################################################################
# Commit certain repositories without intervention
eod_git_commit_repositories ()
{
  if git_repo_has_changes; then
    # echo "==> ci $1"
    git add . > /dev/null || die "failed git add: $1"
    git commit -m "end of day commit" > /dev/null || die "failed commit: $1"
  fi
}

################################################################################
# Sync ~/.comm-sync
eod_comm_sync ()
{
  (cd ~/.comm-sync && sh bin/install.sh) || exit 1
  comm-sync || exit 1
}

################################################################################
# Install all rc files from ~/Develop/pmade/rc
eod_install_rc ()
{
  (cd $HOME/Develop/pmade/rc && make) || die 'rc install failed'
}

################################################################################
# Call the given function for each repo in the list.
#
# $1: The function
# $*: The repos
eod_each_repo ()
{
  block=$1
  shift
  
  for repo in $@; do
    # resolve shell globs like ~/
    eval "repo=$repo"
    
    if test -d $repo; then
      # echo "==> $repo"
      cd $repo || die "failed cd"
      eval "$block \$repo"
    fi
  done
}

################################################################################
stash_ip_address ()
{
  host=`hostname`
  ssh -t pmade.com "who -m|sed -E 's/^[^\(]+\(([^\)]+)\)/\1/' > etc/hosts/$host" > /dev/null 2>&1
}

################################################################################
eod_all_repos_check ()
{
  repo_list=$HOME/Develop/.repo-list
  cache_for=432000
  
  now=`date +%s`
  [ -r $repo_list ] && mtime=`stat -f %Dm $repo_list`
  age=`expr $now - ${mtime:-0}`

  if [ \( ! -r $repo_list \) -o \( ${age:-0} -ge $cache_for \) ]; then
    find $HOME/Develop -name .git -type d > $repo_list
  fi
  
  for repo in `cat $repo_list`; do
    cd `dirname $repo`
    
    if git_repo_has_changes; then
      echo "WARN: git repo with changes: "`pwd`
      return
    fi
    
    if git_repo_needs_push; then
      echo "WARN: git repo needs to be pushed: "`pwd`
      return
    fi
  done
}

################################################################################
die ()
{
  echo "ERROR: $1" > /dev/stderr
  exit 1
}

################################################################################
# Run all of the EOD functions
echo "==> git sync"
eod_each_repo eod_git_check_uncommitted     $git_repositories || die "eod_git_check_uncommitted"
eod_each_repo eod_git_push_all_repositories $git_repositories || die "eod_git_push_all_repositories"

echo "==> comm sync"
eod_comm_sync || die "eod_comm_sync"

echo "==> repo check"
eod_all_repos_check

echo "==> install rc"
eod_install_rc || die "eod_install_rc"

# echo "==> stash IP"
# stash_ip_address
