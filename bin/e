#!/bin/bash

################################################################################
# A very simple wrapper around emacsclient.
set -e

################################################################################
option_server_name="server"
option_server_path="$HOME/.cache/emacs/server/"
option_fresh=0
option_emacs_opts=()

################################################################################
usage () {
cat <<EOF
Usage: e [options] [file] -- [emacsclient options]

  -c      Open a new frame
  -f      Force a fresh Emacs to be started
  -h      This message
  -s NAME Connect to server NAME
  -t      Open a new TTY
EOF
}

################################################################################
while getopts "cfhs:t" o; do
  case "${o}" in
    c) option_emacs_opts+=("--create-frame" "--no-wait")
       ;;

    f) option_fresh=1
       ;;

    h) usage
       exit
       ;;

    s) option_server_name=$OPTARG
       ;;

    t) option_emacs_opts+=("--tty")
       ;;

    *) exit 1
       ;;
  esac
done

shift $((OPTIND-1))

################################################################################
if [ "$option_fresh" -eq 1 ]; then
  export EMACSLOADPATH=""
  exec @emacspath@/emacs -q --load @out@/dot.emacs.el \
         --eval "(run-hooks 'after-init-hook)" "$@"
fi

################################################################################
if [ ! -e "${option_server_path}${option_server_name}" ]; then
  @emacspath@/emacs --daemon="$option_server_name"
fi

################################################################################
@emacspath@/emacsclient --server-file="${option_server_path}${option_server_name}" \
   "${option_emacs_opts[@]}" "$@"
